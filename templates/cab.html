<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAB - Professional Tool Collection</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="CAB应用 - 专业工具集中的全新功能模块">
    <meta name="keywords" content="CAB, 专业工具, 工具集">
    <meta name="author" content="Professional Tool Collection">
    <meta name="robots" content="index, follow">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 80px;
            padding-bottom: 40px;
        }
        
        .cab-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .cab-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .cab-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }
        
        .cab-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .cab-subtitle {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 0;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #f093fb;
            background: #fff5ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #f093fb;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: #adb5bd;
        }
        
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px auto;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .results-container {
            margin-top: 40px;
            display: none;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #f093fb;
        }
        
        .result-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
        }
        
        .similarity-score {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .stats-info {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .loading {
            text-align: center;
            margin: 30px 0;
        }
        
        .spinner-border {
            color: #f093fb;
        }
        
        @media (max-width: 768px) {
            .cab-container {
                margin: 10px;
                padding: 15px;
            }
            
            .cab-title {
                font-size: 1.8rem;
                line-height: 1.3;
                margin-bottom: 15px;
            }
            
            .cab-subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }
            
            .upload-area {
                padding: 25px 15px;
                margin-bottom: 20px;
            }
            
            .upload-text {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 8px;
            }
            
            .upload-hint {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }
            
            .btn {
                font-size: 1rem;
                padding: 12px 20px;
                border-radius: 25px;
                font-weight: 600;
                min-width: 120px;
                margin: 5px;
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
            
            .btn-success {
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                border: none;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            }
            
            .btn-secondary {
                background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
                border: none;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }
            
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            }
            
            .stats-info {
                font-size: 0.95rem;
                padding: 12px 15px;
                margin-bottom: 20px;
                border-radius: 12px;
            }
            
            .result-card {
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 15px;
                box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            }
            
            .result-card h5 {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
            
            .result-card p {
                font-size: 0.95rem;
                margin-bottom: 5px;
            }
            
            .result-card small {
                font-size: 0.85rem;
            }
            
            .similarity-score {
                font-size: 0.9rem;
                padding: 8px 15px;
                border-radius: 20px;
                margin-bottom: 5px;
            }
            
            .form-label {
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 5px;
            }
            
            .form-control, .form-select {
                font-size: 0.9rem;
                padding: 8px 12px;
                border-radius: 8px;
            }
            
            .card {
                border-radius: 15px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            }
            
            .modal-content {
                border-radius: 20px;
                border: none;
            }
            
            .modal-header {
                border-bottom: 1px solid #eee;
                padding: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .image-preview {
                max-width: 100%;
                max-height: 300px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            
            .d-flex.gap-2 {
                gap: 10px !important;
            }
            
            /* 优化调试参数面板 */
            .collapse .card-body {
                padding: 15px;
            }
            
            .row.g-3 {
                --bs-gutter-x: 1rem;
                --bs-gutter-y: 1rem;
            }
            
            /* 让按钮在小屏幕上堆叠更好看 */
            @media (max-width: 480px) {
                .d-flex.gap-2.justify-content-center {
                    flex-direction: column;
                    align-items: center;
                }
                
                .btn {
                    width: 200px;
                    margin: 8px 0;
                }
                
                .col-md-3, .col-md-4 {
                    margin-bottom: 15px;
                }
                
                .result-card .row {
                    text-align: center;
                }
                
                .result-card .col-md-2,
                .result-card .col-md-7,
                .result-card .col-md-3 {
                    margin-bottom: 10px;
                }
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background: rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-tools"></i> 工具集
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/pdf-watermark">
                            <i class="fas fa-file-pdf"></i> PDF水印
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/company-matrix">
                            <i class="fas fa-th"></i> 公司矩阵
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/cab">
                            <i class="fas fa-taxi"></i> CAB
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="cab-container">
            <!-- 页面头部 -->
            <div class="cab-header">
                <div class="cab-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h1 class="cab-title">题目图片相似度匹配</h1>
                <p class="cab-subtitle">上传题目图片，快速找到相似题目和答案</p>
            </div>

            <!-- 系统状态信息 -->
            <div class="stats-info" id="statsInfo">
                <i class="fas fa-info-circle"></i> 正在加载系统信息...
            </div>

            <!-- 图片上传区域 -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">点击或拖拽图片到此处上传</div>
                <div class="upload-hint">支持 JPG, PNG, GIF 等图片格式</div>
                <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
                <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                    <button class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-folder-open"></i> 选择图片
                    </button>
                    <button class="btn btn-success" onclick="openCamera()">
                        <i class="fas fa-camera"></i> 拍照
                    </button>
                </div>
            </div>

            <!-- 图片预览 -->
            <div id="imagePreview" style="display: none; text-align: center;">
                <img id="previewImg" class="image-preview" alt="预览图片">
                <div class="mt-3">
                    <button class="btn btn-primary me-2" id="uploadBtn">
                        <i class="fas fa-search"></i> 开始匹配
                    </button>
                    <button class="btn btn-warning me-2" id="cropBtn">
                        <i class="fas fa-crop"></i> 裁剪图片
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash"></i> 清除图片
                    </button>
                </div>
            </div>

            <!-- 加载状态 -->
            <div class="loading" id="loadingDiv" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">处理中...</span>
                </div>
                <p class="mt-3">正在匹配相似题目，请稍候...</p>
            </div>

            <!-- 匹配结果 -->
            <div class="results-container" id="resultsContainer">
                <h3><i class="fas fa-list"></i> 匹配结果</h3>
                <div id="resultsList"></div>
            </div>

            <!-- 管理功能 -->
            <div class="text-center mt-4">
                <button class="btn btn-secondary me-2" id="rebuildBtn">
                    <i class="fas fa-sync"></i> 重建索引
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-home"></i> 返回首页
                </a>
            </div>

                <!-- 调参面板 -->
                <div class="mt-5">
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#tuningPanel" aria-expanded="false" aria-controls="tuningPanel">
                        <i class="fas fa-sliders-h"></i> 调试参数
                    </button>
                    <div class="collapse mt-3" id="tuningPanel">
                        <div class="card card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">置信度温度 (CAB_SCORE_TEMP)</label>
                                    <input type="number" step="0.01" min="0.01" max="5" class="form-control" id="cfgTemp" value="0.25">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">启用二阶段重排 (CAB_ORB_RERANK)</label>
                                    <select class="form-select" id="cfgRerank">
                                        <option value="1" selected>开启</option>
                                        <option value="0">关闭</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">重排模式 (CAB_RERANK_MODE)</label>
                                    <select class="form-select" id="cfgMode">
                                        <option value="blend" selected>blend</option>
                                        <option value="orb_only">orb_only</option>
                                        <option value="max">max</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB权重 (CAB_ORB_WEIGHT)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgOrbW" value="0.45">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB Lowe比例阈值 (CAB_ORB_RATIO)</label>
                                    <input type="number" step="0.01" min="0.1" max="0.99" class="form-control" id="cfgOrbRatio" value="0.75">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB特征数 (CAB_ORB_NFEATURES)</label>
                                    <input type="number" min="100" max="5000" class="form-control" id="cfgOrbFeat" value="500">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">第一阶段最小归一化相似度 (CAB_ORB_MIN_SIM)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgMinSim" value="0.0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB强匹配加分阈值 (CAB_ORB_BOOST_THRESH)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgBoostTh" value="0.0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">加分幅度 (CAB_ORB_BOOST)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgBoost" value="0.0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ROI 搜索区域 (CAB_ROI_SEARCH_RATIO)</label>
                                    <input type="number" step="0.01" min="0.4" max="0.95" class="form-control" id="cfgRoiSearch" value="0.8">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ROI 最小区域比 (CAB_ROI_MIN_AREA_FRAC)</label>
                                    <input type="number" step="0.0005" min="0.0005" max="0.02" class="form-control" id="cfgRoiMinArea" value="0.002">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ROI 边距像素 (CAB_ROI_PAD)</label>
                                    <input type="number" min="0" max="32" class="form-control" id="cfgRoiPad" value="8">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ROI 回退裁剪 (CAB_FOCUS_REGION)</label>
                                    <input type="text" class="form-control" id="cfgFocusRegion" value="top_left:0.65">
                                    <small class="text-muted">格式: top_left:0.65 或 center:0.6</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- 大图查看模态框 -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">题目大图</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="题目大图" style="max-height: 70vh;">
                    <div class="mt-3">
                        <p id="modalImageInfo" class="mb-1"></p>
                        <small id="modalImageAnswer" class="text-muted"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 照片确认和裁剪模态框 -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cropModalLabel">确认照片</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- 裁剪区域 -->
                    <div class="crop-container" style="max-height: 70vh; overflow: hidden;">
                        <img id="cropImage" style="max-width: 100%; display: block;">
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="retakePhoto()">
                            <i class="fas fa-camera"></i> 重拍
                        </button>
                        <button type="button" class="btn btn-success" onclick="confirmPhotoUse()">
                            <i class="fas fa-check"></i> 使用照片
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">拖拽调整裁剪区域，完成后点击"使用照片"</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Cropper.js JS -->
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素引用
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadBtnDefaultHTML = uploadBtn ? uploadBtn.innerHTML : '';
            const clearBtn = document.getElementById('clearBtn');
            const loadingDiv = document.getElementById('loadingDiv');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsList = document.getElementById('resultsList');
            const rebuildBtn = document.getElementById('rebuildBtn');
            const statsInfo = document.getElementById('statsInfo');
            
            let selectedFile = null;

            // 控制“开始匹配”按钮的加载状态（替代全局Loading）
            function setUploadBtnLoading(isLoading) {
                if (!uploadBtn) return;
                if (isLoading) {
                    uploadBtn.disabled = true;
                    uploadBtn.classList.add('disabled');
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>匹配中...';
                } else {
                    uploadBtn.disabled = false;
                    uploadBtn.classList.remove('disabled');
                    uploadBtn.innerHTML = uploadBtnDefaultHTML || '<i class="fas fa-search"></i> 开始匹配';
                }
            }
            
            // 加载系统统计信息
            loadStats();
            
            // 上传区域点击事件
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });
            
            // 文件选择事件（统一进入裁剪流程）
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 无论来自相册还是相机，都先进入裁剪确认
                    showPhotoConfirmModal(file);
                }
            });
            
            // 拖拽事件
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });
            
            // 处理文件选择
            function handleFileSelection(file) {
                console.log('handleFileSelection 被调用:', file.name);
                
                // 验证文件类型
                if (!file.type.startsWith('image/')) {
                    showAlert('请选择图片文件！', 'warning');
                    return;
                }
                
                // 验证文件大小 (最大10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showAlert('图片文件太大，请选择小于10MB的图片！', 'warning');
                    return;
                }
                
                // 直接显示预览（用于普通文件选择）
                displayImagePreview(file);
            }
            
            // 显示图片预览
            function displayImagePreview(file) {
                console.log('displayImagePreview 被调用:', file.name);
                selectedFile = file;
                
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    uploadArea.style.display = 'none';
                    imagePreview.style.display = 'block';
                    resultsContainer.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
            
            // 上传匹配按钮事件
            uploadBtn.addEventListener('click', function() {
                if (!selectedFile) {
                    showAlert('请先选择图片文件！', 'warning');
                    return;
                }
                
                uploadImageForMatching();
            });
            
            // 清除按钮事件
            clearBtn.addEventListener('click', function() {
                selectedFile = null;
                imageInput.value = '';
                uploadArea.style.display = 'block';
                imagePreview.style.display = 'none';
                resultsContainer.style.display = 'none';
                loadingDiv.style.display = 'none';
            });
            
            // 重建索引按钮事件
            rebuildBtn.addEventListener('click', function() {
                if (confirm('确定要重建索引吗？这个过程可能需要几分钟时间。')) {
                    rebuildIndex();
                }
            });
            
            // 上传图片进行匹配
            async function uploadImageForMatching() {
                if (!selectedFile) return;
                // 使用按钮内置加载效果，隐藏全局loading
                setUploadBtnLoading(true);
                // 不显示全局 loading
                loadingDiv.style.display = 'none';
                resultsContainer.style.display = 'none';
                
                const formData = new FormData();
                formData.append('image', selectedFile);
                // 采集调参配置
                const cfg = {
                    CAB_SCORE_TEMP: parseFloat(document.getElementById('cfgTemp').value || '0.25'),
                    CAB_ORB_RERANK: document.getElementById('cfgRerank').value,
                    CAB_RERANK_MODE: document.getElementById('cfgMode').value,
                    CAB_ORB_WEIGHT: parseFloat(document.getElementById('cfgOrbW').value || '0.45'),
                    CAB_ORB_RATIO: parseFloat(document.getElementById('cfgOrbRatio').value || '0.75'),
                    CAB_ORB_NFEATURES: parseInt(document.getElementById('cfgOrbFeat').value || '500'),
                    CAB_ORB_MIN_SIM: parseFloat(document.getElementById('cfgMinSim').value || '0.0'),
                    CAB_ORB_BOOST_THRESH: parseFloat(document.getElementById('cfgBoostTh').value || '0.0'),
                    CAB_ORB_BOOST: parseFloat(document.getElementById('cfgBoost').value || '0.0'),
                    CAB_ROI_SEARCH_RATIO: parseFloat(document.getElementById('cfgRoiSearch').value || '0.8'),
                    CAB_ROI_MIN_AREA_FRAC: parseFloat(document.getElementById('cfgRoiMinArea').value || '0.002'),
                    CAB_ROI_PAD: parseInt(document.getElementById('cfgRoiPad').value || '8'),
                    CAB_FOCUS_REGION: document.getElementById('cfgFocusRegion').value || 'top_left:0.65'
                };
                formData.append('config', JSON.stringify(cfg));
                
                try {
                    const response = await fetch('/cab/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    setUploadBtnLoading(false);
                    loadingDiv.style.display = 'none';
                    
                    if (data.success) {
                        displayResults(data.matches);
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.message || '匹配失败，请重试', 'danger');
                    }
                    
                } catch (error) {
                    setUploadBtnLoading(false);
                    loadingDiv.style.display = 'none';
                    console.error('Upload error:', error);
                    showAlert('网络错误，请检查连接后重试', 'danger');
                }
            }
            
            // 显示匹配结果
            function displayResults(matches) {
                if (!matches || matches.length === 0) {
                    resultsList.innerHTML = '<div class="text-center text-muted">未找到相似的题目</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                let html = '';
                matches.forEach((match, index) => {
                    // 优先显示后端校准后的置信度，如果没有则退化为相似度
                    const displayPercent = (match.confidence_percent !== undefined)
                        ? match.confidence_percent.toFixed(1)
                        : (match.similarity * 100).toFixed(1);
                    const subtitle = (match.confidence_percent !== undefined)
                        ? `相似度: ${(match.similarity * 100).toFixed(1)}%`
                        : '';
                    html += `
                        <div class="result-card">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <img src="/question-images/${match.filename}" 
                                         class="result-image img-fluid" 
                                         alt="题目图片"
                                         style="cursor: pointer;"
                                         onclick="showImageModal('/question-images/${match.filename}', '${match.filename}', '${match.answer}')"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuaXoOazleeUn+aIkDwvdGV4dD48L3N2Zz4='"
                                         title="点击查看大图">
                                </div>
                                <div class="col-md-7">
                                    <h5>题目 ${index + 1}: ${match.filename}</h5>
                                    <p class="mb-2"><strong>答案：</strong>${match.answer}</p>
                                    <small class="text-muted">文件名: ${match.filename}</small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="similarity-score">
                                        置信度: ${displayPercent}%
                                    </div>
                                    ${subtitle ? `<small class="text-muted d-block mt-1">${subtitle}</small>` : ''}
                                    <small class="text-muted d-block mt-1">排名: #${match.rank}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultsList.innerHTML = html;
                resultsContainer.style.display = 'block';
            }
            
            // 显示大图模态框
            window.showImageModal = function(imageSrc, filename, answer) {
                const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                const modalImage = document.getElementById('modalImage');
                const modalImageInfo = document.getElementById('modalImageInfo');
                const modalImageAnswer = document.getElementById('modalImageAnswer');
                
                modalImage.src = imageSrc;
                modalImageInfo.textContent = `文件名: ${filename}`;
                modalImageAnswer.textContent = answer ? `答案: ${answer}` : '无答案信息';
                
                modal.show();
            };

            // 预热相机功能（在页面加载时）
            let cameraWarmedUp = false;
            
            // 打开相机拍照
            window.openCamera = function() {
                console.log('开始打开相机...');
                
                // 如果是第一次使用相机，先进行预热
                if (!cameraWarmedUp) {
                    console.log('首次使用相机，进行预热...');
                    cameraWarmedUp = true;
                    
                    // 创建一个隐藏的预热输入框，激活权限
                    const warmupInput = document.createElement('input');
                    warmupInput.type = 'file';
                    warmupInput.accept = 'image/*';
                    warmupInput.style.position = 'absolute';
                    warmupInput.style.left = '-9999px';
                    document.body.appendChild(warmupInput);
                    
                    setTimeout(() => {
                        if (document.body.contains(warmupInput)) {
                            document.body.removeChild(warmupInput);
                        }
                        // 预热完成后再次调用相机
                        actualOpenCamera();
                    }, 100);
                    return;
                }
                
                actualOpenCamera();
            };
            
            // 实际打开相机的函数
            function actualOpenCamera() {
                
                // 创建一个专门用于拍照的文件输入框
                const cameraInput = document.createElement('input');
                cameraInput.type = 'file';
                cameraInput.accept = 'image/*';
                cameraInput.capture = 'environment'; // 使用后置摄像头
                cameraInput.style.display = 'none';
                
                // 添加多个事件监听器
                cameraInput.onchange = function(e) {
                    console.log('相机input change事件触发', e.target.files);
                    handleCameraResult(e.target.files, cameraInput);
                };
                
                cameraInput.oninput = function(e) {
                    console.log('相机input input事件触发', e.target.files);
                    handleCameraResult(e.target.files, cameraInput);
                };
                
                // 添加焦点返回监听（用户从相机应用返回时）
                const handleFocusReturn = function() {
                    console.log('页面重新获得焦点');
                    setTimeout(() => {
                        if (cameraInput.files && cameraInput.files.length > 0) {
                            console.log('延迟检查到文件:', cameraInput.files);
                            handleCameraResult(cameraInput.files, cameraInput);
                        } else {
                            console.log('焦点返回但没有文件，清理输入框');
                            if (document.body.contains(cameraInput)) {
                                document.body.removeChild(cameraInput);
                            }
                            window.removeEventListener('focus', handleFocusReturn);
                        }
                    }, 500); // 给相机应用一些时间来设置文件
                };
                
                window.addEventListener('focus', handleFocusReturn);
                
                document.body.appendChild(cameraInput);
                cameraInput.click();
                console.log('相机输入框已点击');
            }
            
            // 处理相机拍照结果
            function handleCameraResult(files, inputElement) {
                console.log('=== handleCameraResult 被调用 ===');
                console.log('接收到的files:', files);
                console.log('files数量:', files ? files.length : 0);
                
                if (files && files.length > 0) {
                    const file = files[0];
                    console.log('处理相机结果 - 文件名:', file.name);
                    console.log('处理相机结果 - 文件大小:', file.size);
                    console.log('处理相机结果 - 文件类型:', file.type);
                    console.log('即将调用 showPhotoConfirmModal...');
                    
                    // 延迟一下确保DOM准备好
                    setTimeout(() => {
                        console.log('=== 准备调用 showPhotoConfirmModal ===');
                        showPhotoConfirmModal(file);
                    }, 200);
                } else {
                    console.log('没有接收到有效的文件');
                }
                
                // 清理输入框
                if (inputElement && document.body.contains(inputElement)) {
                    document.body.removeChild(inputElement);
                    console.log('已清理输入框');
                }
                
                // 移除焦点监听器
                window.removeEventListener('focus', arguments.callee);
            }

            // 裁剪相关变量
            let currentPhotoFile = null;
            let cropper = null;
            let isCropMode = false;

            // 显示照片确认模态框
            function showPhotoConfirmModal(file) {
                console.log('=== showPhotoConfirmModal 开始执行 ===');
                console.log('showPhotoConfirmModal called with file:', file);
                console.log('File size:', file.size, 'File type:', file.type);
                
                // 立即测试DOM元素是否存在
                const testModal = document.getElementById('cropModal');
                const testImage = document.getElementById('cropImage');
                console.log('立即检查 - cropModal 存在:', !!testModal);
                console.log('立即检查 - cropImage 存在:', !!testImage);
                
                if (!testModal || !testImage) {
                    console.error('=== 关键DOM元素缺失！===');
                    console.log('页面当前所有ID元素:', Array.from(document.querySelectorAll('[id]')).map(el => el.id));
                    alert('无法找到裁剪相关的DOM元素，请检查页面是否完全加载！');
                    return;
                }
                
                try {
                    currentPhotoFile = file;
                    const cropModalElement = document.getElementById('cropModal');
                    const cropImage = document.getElementById('cropImage');
                    
                    console.log('cropModalElement found:', !!cropModalElement);
                    console.log('cropImage found:', !!cropImage);
                    
                    if (!cropModalElement) {
                        console.error('cropModal element not found - 这是一个严重错误！');
                        console.error('DOM中的所有元素ID:', Array.from(document.querySelectorAll('[id]')).map(el => el.id));
                        alert('错误：无法找到裁剪模态框！请刷新页面重试。');
                        return;
                    }
                    
                    if (!cropImage) {
                        console.error('cropImage element not found - 这是一个严重错误！');
                        alert('错误：无法找到裁剪图片元素！请刷新页面重试。');
                        return;
                    }
                    
                    // 销毁已存在的cropper
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('图片文件读取完成，设置图片源...');
                        cropImage.src = e.target.result;
                        
                        // 等待图片加载完成
                        cropImage.onload = function() {
                            console.log('图片加载完成，显示模态框...');
                            
                            // 显示模态框
                            const modal = new bootstrap.Modal(cropModalElement);
                            modal.show();
                            
                            // 等待模态框完全显示后初始化裁剪器
                            cropModalElement.addEventListener('shown.bs.modal', function initCropper() {
                                console.log('模态框显示完成，开始初始化裁剪器...');
                                
                                try {
                                    // 直接进入裁剪模式
                                    isCropMode = true;
                                    
                                    // 初始化Cropper.js
                                    cropper = new Cropper(cropImage, {
                                        aspectRatio: NaN, // 自由比例
                                        viewMode: 1,
                                        dragMode: 'move',
                                        autoCropArea: 0.8,
                                        restore: false,
                                        guides: true,
                                        center: true,
                                        highlight: false,
                                        cropBoxMovable: true,
                                        cropBoxResizable: true,
                                        toggleDragModeOnDblclick: false,
                                        background: false,
                                        modal: true,
                                        responsive: true,
                                        movable: true,
                                        rotatable: false,
                                        scalable: false,
                                        zoomable: true,
                                        zoomOnTouch: true,
                                        zoomOnWheel: true,
                                        ready: function() {
                                            console.log('Cropper.js 完全初始化完成！');
                                        }
                                    });
                                    
                                    console.log('裁剪器初始化完成');
                                } catch (cropperError) {
                                    console.error('Cropper.js初始化失败:', cropperError);
                                }
                                
                                // 移除事件监听器，避免重复执行
                                cropModalElement.removeEventListener('shown.bs.modal', initCropper);
                            }, { once: true });
                        };
                        
                        console.log('准备显示照片确认页面...');
                    };
                    reader.onerror = function() {
                        console.error('文件读取失败');
                        alert('错误：无法读取图片文件！请重试。');
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('showPhotoConfirmModal error:', error);
                    alert('错误：裁剪功能初始化失败！错误信息：' + error.message);
                }
            }

            // 更新裁剪切换按钮
            function updateCropToggleButton() {
                const toggleIcon = document.getElementById('cropToggleIcon');
                const toggleText = document.getElementById('cropToggleText');
                
                if (isCropMode) {
                    toggleIcon.className = 'fas fa-times';
                    toggleText.textContent = '取消裁剪';
                } else {
                    toggleIcon.className = 'fas fa-crop';
                    toggleText.textContent = '开始裁剪';
                }
            }

            // 切换裁剪模式
            window.toggleCropMode = function() {
                const cropImage = document.getElementById('cropImage');
                
                if (!isCropMode) {
                    // 开始裁剪模式
                    console.log('开始裁剪模式');
                    isCropMode = true;
                    
                    // 初始化Cropper.js
                    cropper = new Cropper(cropImage, {
                        aspectRatio: NaN, // 自由比例
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        background: false,
                        modal: true,
                        responsive: true,
                        movable: true,
                        rotatable: false,
                        scalable: false,
                        zoomable: true,
                        zoomOnTouch: true,
                        zoomOnWheel: true,
                    });
                    
                    updateCropToggleButton();
                    showAlert('拖拽调整裁剪区域，完成后点击"使用照片"', 'info');
                } else {
                    // 取消裁剪模式
                    console.log('取消裁剪模式');
                    isCropMode = false;
                    
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                    
                    updateCropToggleButton();
                }
            };

            // 重拍照片
            window.retakePhoto = function() {
                console.log('重拍照片');
                
                // 销毁cropper
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('cropModal'));
                if (modal) {
                    modal.hide();
                }
                
                // 重新打开相机
                setTimeout(() => {
                    openCamera();
                }, 300);
            };

            // 确认使用照片
            window.confirmPhotoUse = function() {
                console.log('确认使用照片');
                
                if (cropper) {
                    // 获取裁剪后的图片
                    console.log('获取裁剪后的图片');
                    
                    cropper.getCroppedCanvas({
                        width: 800,
                        height: 800,
                        fillColor: '#fff',
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high',
                    }).toBlob(function(blob) {
                        // 创建新的文件对象
                        const fileName = `cropped_photo_${Date.now()}.jpg`;
                        selectedFile = new File([blob], fileName, { type: 'image/jpeg' });
                        
                        // 销毁cropper
                        cropper.destroy();
                        cropper = null;
                        
                        // 关闭模态框并显示预览
                        const modal = bootstrap.Modal.getInstance(document.getElementById('cropModal'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        setTimeout(() => {
                            displayImagePreview(selectedFile);
                            showAlert('照片已裁剪完成，可以开始匹配！', 'success');
                        }, 300);
                        
                    }, 'image/jpeg', 0.9);
                } else {
                    // 如果cropper没有初始化，直接使用原照片
                    selectedFile = currentPhotoFile;
                    
                    // 关闭模态框并显示预览
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cropModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    setTimeout(() => {
                        displayImagePreview(selectedFile);
                        showAlert('照片已准备就绪，可以开始匹配！', 'success');
                    }, 300);
                }
            };

            // 设置裁剪画布
            function setupCropCanvas() {
                const maxWidth = Math.min(600, window.innerWidth - 100);
                const maxHeight = 400;
                
                imageScale = Math.min(maxWidth / cropImage.width, maxHeight / cropImage.height, 1);
                
                cropCanvas.width = cropImage.width * imageScale;
                cropCanvas.height = cropImage.height * imageScale;
                
                // 居中显示
                imageOffsetX = 0;
                imageOffsetY = 0;
                
                // 默认选择中心区域
                const defaultSize = Math.min(cropCanvas.width, cropCanvas.height) * 0.8;
                cropRect = {
                    x: (cropCanvas.width - defaultSize) / 2,
                    y: (cropCanvas.height - defaultSize) / 2,
                    width: defaultSize,
                    height: defaultSize
                };
                
                // 添加事件监听
                cropCanvas.addEventListener('mousedown', startCrop);
                cropCanvas.addEventListener('mousemove', updateCrop);
                cropCanvas.addEventListener('mouseup', endCrop);
                cropCanvas.addEventListener('touchstart', handleTouch);
                cropCanvas.addEventListener('touchmove', handleTouch);
                cropCanvas.addEventListener('touchend', handleTouch);
                cropCanvas.addEventListener('dblclick', confirmCrop);
            }

            // 绘制裁剪画布
            function drawCropCanvas() {
                cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
                
                // 绘制图片
                cropCtx.drawImage(cropImage, 0, 0, cropCanvas.width, cropCanvas.height);
                
                // 绘制遮罩
                cropCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                cropCtx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
                
                // 清除选择区域
                cropCtx.globalCompositeOperation = 'destination-out';
                cropCtx.fillRect(cropRect.x, cropRect.y, cropRect.width, cropRect.height);
                
                // 重新绘制选择区域的图片
                cropCtx.globalCompositeOperation = 'source-over';
                cropCtx.drawImage(
                    cropImage,
                    cropRect.x / imageScale, cropRect.y / imageScale,
                    cropRect.width / imageScale, cropRect.height / imageScale,
                    cropRect.x, cropRect.y, cropRect.width, cropRect.height
                );
                
                // 绘制选择框
                cropCtx.strokeStyle = '#007bff';
                cropCtx.lineWidth = 2;
                cropCtx.strokeRect(cropRect.x, cropRect.y, cropRect.width, cropRect.height);
                
                // 绘制角点
                const cornerSize = 8;
                cropCtx.fillStyle = '#007bff';
                const corners = [
                    [cropRect.x - cornerSize/2, cropRect.y - cornerSize/2],
                    [cropRect.x + cropRect.width - cornerSize/2, cropRect.y - cornerSize/2],
                    [cropRect.x - cornerSize/2, cropRect.y + cropRect.height - cornerSize/2],
                    [cropRect.x + cropRect.width - cornerSize/2, cropRect.y + cropRect.height - cornerSize/2]
                ];
                corners.forEach(([x, y]) => {
                    cropCtx.fillRect(x, y, cornerSize, cornerSize);
                });
            }

            // 开始裁剪
            function startCrop(e) {
                isDrawing = true;
                const rect = cropCanvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (cropCanvas.width / rect.width);
                startY = (e.clientY - rect.top) * (cropCanvas.height / rect.height);
            }

            // 更新裁剪
            function updateCrop(e) {
                if (!isDrawing) return;
                
                const rect = cropCanvas.getBoundingClientRect();
                const currentX = (e.clientX - rect.left) * (cropCanvas.width / rect.width);
                const currentY = (e.clientY - rect.top) * (cropCanvas.height / rect.height);
                
                cropRect.x = Math.min(startX, currentX);
                cropRect.y = Math.min(startY, currentY);
                cropRect.width = Math.abs(currentX - startX);
                cropRect.height = Math.abs(currentY - startY);
                
                // 限制在画布范围内
                cropRect.x = Math.max(0, Math.min(cropRect.x, cropCanvas.width - cropRect.width));
                cropRect.y = Math.max(0, Math.min(cropRect.y, cropCanvas.height - cropRect.height));
                cropRect.width = Math.min(cropRect.width, cropCanvas.width - cropRect.x);
                cropRect.height = Math.min(cropRect.height, cropCanvas.height - cropRect.y);
                
                drawCropCanvas();
            }

            // 结束裁剪
            function endCrop() {
                isDrawing = false;
            }

            // 处理触摸事件
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0] || e.changedTouches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                cropCanvas.dispatchEvent(mouseEvent);
            }

            // 重置裁剪
            window.resetCrop = function() {
                const size = Math.min(cropCanvas.width, cropCanvas.height) * 0.8;
                cropRect = {
                    x: (cropCanvas.width - size) / 2,
                    y: (cropCanvas.height - size) / 2,
                    width: size,
                    height: size
                };
                drawCropCanvas();
            };

            // 预设裁剪区域
            window.presetCrop = function(type) {
                if (type === 'center') {
                    const size = Math.min(cropCanvas.width, cropCanvas.height) * 0.6;
                    cropRect = {
                        x: (cropCanvas.width - size) / 2,
                        y: (cropCanvas.height - size) / 2,
                        width: size,
                        height: size
                    };
                } else if (type === 'top-left') {
                    const size = Math.min(cropCanvas.width, cropCanvas.height) * 0.7;
                    cropRect = {
                        x: 0,
                        y: 0,
                        width: size,
                        height: size
                    };
                }
                drawCropCanvas();
            };

            // 确认裁剪
            window.confirmCrop = function() {
                if (!cropImage || cropRect.width === 0 || cropRect.height === 0) {
                    showAlert('请先选择裁剪区域', 'warning');
                    return;
                }
                
                // 创建新的canvas来生成裁剪后的图片
                const outputCanvas = document.createElement('canvas');
                const outputCtx = outputCanvas.getContext('2d');
                
                // 计算实际裁剪区域
                const actualX = cropRect.x / imageScale;
                const actualY = cropRect.y / imageScale;
                const actualWidth = cropRect.width / imageScale;
                const actualHeight = cropRect.height / imageScale;
                
                outputCanvas.width = actualWidth;
                outputCanvas.height = actualHeight;
                
                // 绘制裁剪后的图片
                outputCtx.drawImage(
                    cropImage,
                    actualX, actualY, actualWidth, actualHeight,
                    0, 0, actualWidth, actualHeight
                );
                
                // 转换为blob
                outputCanvas.toBlob(function(blob) {
                    // 创建新的文件对象
                    const fileName = `cropped_photo_${Date.now()}.jpg`;
                    selectedFile = new File([blob], fileName, { type: 'image/jpeg' });
                    
                    // 显示预览
                    displayImagePreview(selectedFile);
                    
                    // 关闭裁剪模态框
                    bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
                    
                    showAlert('照片裁剪完成，可以开始匹配！', 'success');
                }, 'image/jpeg', 0.9);
            };

            // 重建索引
            async function rebuildIndex() {
                rebuildBtn.disabled = true;
                rebuildBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 重建中...';
                
                try {
                    const response = await fetch('/cab/rebuild-index', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(data.message, 'success');
                        loadStats(); // 重新加载统计信息
                    } else {
                        showAlert(data.message || '重建索引失败', 'danger');
                    }
                    
                } catch (error) {
                    console.error('Rebuild error:', error);
                    showAlert('网络错误，请检查连接后重试', 'danger');
                } finally {
                    rebuildBtn.disabled = false;
                    rebuildBtn.innerHTML = '<i class="fas fa-sync"></i> 重建索引';
                }
            }
            
            // 加载系统统计信息
            async function loadStats() {
                try {
                    const response = await fetch('/cab/stats');
                    const data = await response.json();
                    
                    if (data.success) {
                        const stats = data.stats;
                        statsInfo.innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            系统状态: 题目库包含 <strong>${stats.total_images}</strong> 张图片，
                            索引维度 <strong>${stats.feature_dimension}</strong>，
                            索引状态: ${stats.index_exists ? '<span class="text-success">已建立</span>' : '<span class="text-warning">未建立</span>'}
                        `;
                    } else {
                        statsInfo.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i> 
                            <span class="text-warning">${data.message}</span>
                        `;
                    }
                } catch (error) {
                    console.error('Stats error:', error);
                    statsInfo.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        <span class="text-danger">无法加载系统信息</span>
                    `;
                }
            }
            
            // 显示提示信息
            function showAlert(message, type) {
                // 创建alert元素
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // 插入到页面顶部
                const container = document.querySelector('.cab-container');
                container.insertBefore(alertDiv, container.firstChild);
                
                // 5秒后自动消失
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>