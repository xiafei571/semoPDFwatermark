<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAB - Professional Tool Collection</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="CAB应用 - 专业工具集中的全新功能模块">
    <meta name="keywords" content="CAB, 专业工具, 工具集">
    <meta name="author" content="Professional Tool Collection">
    <meta name="robots" content="index, follow">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 80px;
            padding-bottom: 40px;
        }
        
        .cab-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .cab-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .cab-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }
        
        .cab-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .cab-subtitle {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 0;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #f093fb;
            background: #fff5ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #f093fb;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: #adb5bd;
        }
        
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px auto;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .results-container {
            margin-top: 40px;
            display: none;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #f093fb;
        }
        
        .result-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
        }
        
        .similarity-score {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .stats-info {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .loading {
            text-align: center;
            margin: 30px 0;
        }
        
        .spinner-border {
            color: #f093fb;
        }
        
        @media (max-width: 768px) {
            .cab-container {
                margin: 20px;
                padding: 20px;
            }
            
            .cab-title {
                font-size: 2rem;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .result-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background: rgba(0,0,0,0.1); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-tools"></i> 工具集
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/pdf-watermark">
                            <i class="fas fa-file-pdf"></i> PDF水印
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/company-matrix">
                            <i class="fas fa-th"></i> 公司矩阵
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/cab">
                            <i class="fas fa-taxi"></i> CAB
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="cab-container">
            <!-- 页面头部 -->
            <div class="cab-header">
                <div class="cab-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h1 class="cab-title">题目图片相似度匹配</h1>
                <p class="cab-subtitle">上传题目图片，快速找到相似题目和答案</p>
            </div>

            <!-- 系统状态信息 -->
            <div class="stats-info" id="statsInfo">
                <i class="fas fa-info-circle"></i> 正在加载系统信息...
            </div>

            <!-- 图片上传区域 -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">点击或拖拽图片到此处上传</div>
                <div class="upload-hint">支持 JPG, PNG, GIF 等图片格式</div>
                <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
                <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                    <button class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-folder-open"></i> 选择图片
                    </button>
                    <button class="btn btn-success" onclick="openCamera()">
                        <i class="fas fa-camera"></i> 拍照
                    </button>
                </div>
            </div>

            <!-- 图片预览 -->
            <div id="imagePreview" style="display: none; text-align: center;">
                <img id="previewImg" class="image-preview" alt="预览图片">
                <div class="mt-3">
                    <button class="btn btn-primary me-2" id="uploadBtn">
                        <i class="fas fa-search"></i> 开始匹配
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash"></i> 清除图片
                    </button>
                </div>
            </div>

            <!-- 加载状态 -->
            <div class="loading" id="loadingDiv" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">处理中...</span>
                </div>
                <p class="mt-3">正在匹配相似题目，请稍候...</p>
            </div>

            <!-- 匹配结果 -->
            <div class="results-container" id="resultsContainer">
                <h3><i class="fas fa-list"></i> 匹配结果</h3>
                <div id="resultsList"></div>
            </div>

            <!-- 管理功能 -->
            <div class="text-center mt-4">
                <button class="btn btn-secondary me-2" id="rebuildBtn">
                    <i class="fas fa-sync"></i> 重建索引
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-home"></i> 返回首页
                </a>
            </div>

                <!-- 调参面板 -->
                <div class="mt-5">
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#tuningPanel" aria-expanded="false" aria-controls="tuningPanel">
                        <i class="fas fa-sliders-h"></i> 调试参数
                    </button>
                    <div class="collapse mt-3" id="tuningPanel">
                        <div class="card card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">置信度温度 (CAB_SCORE_TEMP)</label>
                                    <input type="number" step="0.01" min="0.01" max="5" class="form-control" id="cfgTemp" value="0.25">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">启用二阶段重排 (CAB_ORB_RERANK)</label>
                                    <select class="form-select" id="cfgRerank">
                                        <option value="1" selected>开启</option>
                                        <option value="0">关闭</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">重排模式 (CAB_RERANK_MODE)</label>
                                    <select class="form-select" id="cfgMode">
                                        <option value="blend" selected>blend</option>
                                        <option value="orb_only">orb_only</option>
                                        <option value="max">max</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB权重 (CAB_ORB_WEIGHT)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgOrbW" value="0.45">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB Lowe比例阈值 (CAB_ORB_RATIO)</label>
                                    <input type="number" step="0.01" min="0.1" max="0.99" class="form-control" id="cfgOrbRatio" value="0.75">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB特征数 (CAB_ORB_NFEATURES)</label>
                                    <input type="number" min="100" max="5000" class="form-control" id="cfgOrbFeat" value="500">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">第一阶段最小归一化相似度 (CAB_ORB_MIN_SIM)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgMinSim" value="0.0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ORB强匹配加分阈值 (CAB_ORB_BOOST_THRESH)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgBoostTh" value="0.0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">加分幅度 (CAB_ORB_BOOST)</label>
                                    <input type="number" step="0.01" min="0" max="1" class="form-control" id="cfgBoost" value="0.0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ROI 搜索区域 (CAB_ROI_SEARCH_RATIO)</label>
                                    <input type="number" step="0.01" min="0.4" max="0.95" class="form-control" id="cfgRoiSearch" value="0.8">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ROI 最小区域比 (CAB_ROI_MIN_AREA_FRAC)</label>
                                    <input type="number" step="0.0005" min="0.0005" max="0.02" class="form-control" id="cfgRoiMinArea" value="0.002">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ROI 边距像素 (CAB_ROI_PAD)</label>
                                    <input type="number" min="0" max="32" class="form-control" id="cfgRoiPad" value="8">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ROI 回退裁剪 (CAB_FOCUS_REGION)</label>
                                    <input type="text" class="form-control" id="cfgFocusRegion" value="top_left:0.65">
                                    <small class="text-muted">格式: top_left:0.65 或 center:0.6</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- 大图查看模态框 -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">题目大图</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="题目大图" style="max-height: 70vh;">
                    <div class="mt-3">
                        <p id="modalImageInfo" class="mb-1"></p>
                        <small id="modalImageAnswer" class="text-muted"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素引用
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const uploadBtn = document.getElementById('uploadBtn');
            const clearBtn = document.getElementById('clearBtn');
            const loadingDiv = document.getElementById('loadingDiv');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsList = document.getElementById('resultsList');
            const rebuildBtn = document.getElementById('rebuildBtn');
            const statsInfo = document.getElementById('statsInfo');
            
            let selectedFile = null;
            
            // 加载系统统计信息
            loadStats();
            
            // 上传区域点击事件
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });
            
            // 文件选择事件
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleFileSelection(file);
                }
            });
            
            // 拖拽事件
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });
            
            // 处理文件选择
            function handleFileSelection(file) {
                // 验证文件类型
                if (!file.type.startsWith('image/')) {
                    showAlert('请选择图片文件！', 'warning');
                    return;
                }
                
                // 验证文件大小 (最大10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showAlert('图片文件太大，请选择小于10MB的图片！', 'warning');
                    return;
                }
                
                selectedFile = file;
                
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    uploadArea.style.display = 'none';
                    imagePreview.style.display = 'block';
                    resultsContainer.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
            
            // 上传匹配按钮事件
            uploadBtn.addEventListener('click', function() {
                if (!selectedFile) {
                    showAlert('请先选择图片文件！', 'warning');
                    return;
                }
                
                uploadImageForMatching();
            });
            
            // 清除按钮事件
            clearBtn.addEventListener('click', function() {
                selectedFile = null;
                imageInput.value = '';
                uploadArea.style.display = 'block';
                imagePreview.style.display = 'none';
                resultsContainer.style.display = 'none';
                loadingDiv.style.display = 'none';
            });
            
            // 重建索引按钮事件
            rebuildBtn.addEventListener('click', function() {
                if (confirm('确定要重建索引吗？这个过程可能需要几分钟时间。')) {
                    rebuildIndex();
                }
            });
            
            // 上传图片进行匹配
            async function uploadImageForMatching() {
                if (!selectedFile) return;
                
                loadingDiv.style.display = 'block';
                resultsContainer.style.display = 'none';
                
                const formData = new FormData();
                formData.append('image', selectedFile);
                // 采集调参配置
                const cfg = {
                    CAB_SCORE_TEMP: parseFloat(document.getElementById('cfgTemp').value || '0.25'),
                    CAB_ORB_RERANK: document.getElementById('cfgRerank').value,
                    CAB_RERANK_MODE: document.getElementById('cfgMode').value,
                    CAB_ORB_WEIGHT: parseFloat(document.getElementById('cfgOrbW').value || '0.45'),
                    CAB_ORB_RATIO: parseFloat(document.getElementById('cfgOrbRatio').value || '0.75'),
                    CAB_ORB_NFEATURES: parseInt(document.getElementById('cfgOrbFeat').value || '500'),
                    CAB_ORB_MIN_SIM: parseFloat(document.getElementById('cfgMinSim').value || '0.0'),
                    CAB_ORB_BOOST_THRESH: parseFloat(document.getElementById('cfgBoostTh').value || '0.0'),
                    CAB_ORB_BOOST: parseFloat(document.getElementById('cfgBoost').value || '0.0'),
                    CAB_ROI_SEARCH_RATIO: parseFloat(document.getElementById('cfgRoiSearch').value || '0.8'),
                    CAB_ROI_MIN_AREA_FRAC: parseFloat(document.getElementById('cfgRoiMinArea').value || '0.002'),
                    CAB_ROI_PAD: parseInt(document.getElementById('cfgRoiPad').value || '8'),
                    CAB_FOCUS_REGION: document.getElementById('cfgFocusRegion').value || 'top_left:0.65'
                };
                formData.append('config', JSON.stringify(cfg));
                
                try {
                    const response = await fetch('/cab/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    loadingDiv.style.display = 'none';
                    
                    if (data.success) {
                        displayResults(data.matches);
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.message || '匹配失败，请重试', 'danger');
                    }
                    
                } catch (error) {
                    loadingDiv.style.display = 'none';
                    console.error('Upload error:', error);
                    showAlert('网络错误，请检查连接后重试', 'danger');
                }
            }
            
            // 显示匹配结果
            function displayResults(matches) {
                if (!matches || matches.length === 0) {
                    resultsList.innerHTML = '<div class="text-center text-muted">未找到相似的题目</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                let html = '';
                matches.forEach((match, index) => {
                    // 优先显示后端校准后的置信度，如果没有则退化为相似度
                    const displayPercent = (match.confidence_percent !== undefined)
                        ? match.confidence_percent.toFixed(1)
                        : (match.similarity * 100).toFixed(1);
                    const subtitle = (match.confidence_percent !== undefined)
                        ? `相似度: ${(match.similarity * 100).toFixed(1)}%`
                        : '';
                    html += `
                        <div class="result-card">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <img src="/question-images/${match.filename}" 
                                         class="result-image img-fluid" 
                                         alt="题目图片"
                                         style="cursor: pointer;"
                                         onclick="showImageModal('/question-images/${match.filename}', '${match.filename}', '${match.answer}')"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuaXoOazleeUn+aIkDwvdGV4dD48L3N2Zz4='"
                                         title="点击查看大图">
                                </div>
                                <div class="col-md-7">
                                    <h5>题目 ${index + 1}: ${match.filename}</h5>
                                    <p class="mb-2"><strong>答案：</strong>${match.answer}</p>
                                    <small class="text-muted">文件名: ${match.filename}</small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="similarity-score">
                                        置信度: ${displayPercent}%
                                    </div>
                                    ${subtitle ? `<small class="text-muted d-block mt-1">${subtitle}</small>` : ''}
                                    <small class="text-muted d-block mt-1">排名: #${match.rank}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultsList.innerHTML = html;
                resultsContainer.style.display = 'block';
            }
            
            // 显示大图模态框
            window.showImageModal = function(imageSrc, filename, answer) {
                const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                const modalImage = document.getElementById('modalImage');
                const modalImageInfo = document.getElementById('modalImageInfo');
                const modalImageAnswer = document.getElementById('modalImageAnswer');
                
                modalImage.src = imageSrc;
                modalImageInfo.textContent = `文件名: ${filename}`;
                modalImageAnswer.textContent = answer ? `答案: ${answer}` : '无答案信息';
                
                modal.show();
            };

            // 预热相机功能（在页面加载时）
            let cameraWarmedUp = false;
            
            // 打开相机拍照
            window.openCamera = function() {
                console.log('开始打开相机...');
                
                // 如果是第一次使用相机，先进行预热
                if (!cameraWarmedUp) {
                    console.log('首次使用相机，进行预热...');
                    cameraWarmedUp = true;
                    
                    // 创建一个隐藏的预热输入框，激活权限
                    const warmupInput = document.createElement('input');
                    warmupInput.type = 'file';
                    warmupInput.accept = 'image/*';
                    warmupInput.style.position = 'absolute';
                    warmupInput.style.left = '-9999px';
                    document.body.appendChild(warmupInput);
                    
                    setTimeout(() => {
                        if (document.body.contains(warmupInput)) {
                            document.body.removeChild(warmupInput);
                        }
                        // 预热完成后再次调用相机
                        actualOpenCamera();
                    }, 100);
                    return;
                }
                
                actualOpenCamera();
            };
            
            // 实际打开相机的函数
            function actualOpenCamera() {
                
                // 创建一个专门用于拍照的文件输入框
                const cameraInput = document.createElement('input');
                cameraInput.type = 'file';
                cameraInput.accept = 'image/*';
                cameraInput.capture = 'environment'; // 使用后置摄像头
                cameraInput.style.display = 'none';
                
                // 添加多个事件监听器
                cameraInput.onchange = function(e) {
                    console.log('相机input change事件触发', e.target.files);
                    handleCameraResult(e.target.files, cameraInput);
                };
                
                cameraInput.oninput = function(e) {
                    console.log('相机input input事件触发', e.target.files);
                    handleCameraResult(e.target.files, cameraInput);
                };
                
                // 添加焦点返回监听（用户从相机应用返回时）
                const handleFocusReturn = function() {
                    console.log('页面重新获得焦点');
                    setTimeout(() => {
                        if (cameraInput.files && cameraInput.files.length > 0) {
                            console.log('延迟检查到文件:', cameraInput.files);
                            handleCameraResult(cameraInput.files, cameraInput);
                        } else {
                            console.log('焦点返回但没有文件，清理输入框');
                            if (document.body.contains(cameraInput)) {
                                document.body.removeChild(cameraInput);
                            }
                            window.removeEventListener('focus', handleFocusReturn);
                        }
                    }, 500); // 给相机应用一些时间来设置文件
                };
                
                window.addEventListener('focus', handleFocusReturn);
                
                document.body.appendChild(cameraInput);
                cameraInput.click();
                console.log('相机输入框已点击');
            }
            
            // 处理相机拍照结果
            function handleCameraResult(files, inputElement) {
                if (files && files.length > 0) {
                    console.log('处理相机结果:', files[0]);
                    selectedFile = files[0];
                    displayImagePreview(selectedFile);
                    showAlert('照片已选择，可以开始匹配！', 'success');
                }
                
                // 清理输入框
                if (inputElement && document.body.contains(inputElement)) {
                    document.body.removeChild(inputElement);
                }
                
                // 移除焦点监听器
                window.removeEventListener('focus', arguments.callee);
            }

            // 重建索引
            async function rebuildIndex() {
                rebuildBtn.disabled = true;
                rebuildBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 重建中...';
                
                try {
                    const response = await fetch('/cab/rebuild-index', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(data.message, 'success');
                        loadStats(); // 重新加载统计信息
                    } else {
                        showAlert(data.message || '重建索引失败', 'danger');
                    }
                    
                } catch (error) {
                    console.error('Rebuild error:', error);
                    showAlert('网络错误，请检查连接后重试', 'danger');
                } finally {
                    rebuildBtn.disabled = false;
                    rebuildBtn.innerHTML = '<i class="fas fa-sync"></i> 重建索引';
                }
            }
            
            // 加载系统统计信息
            async function loadStats() {
                try {
                    const response = await fetch('/cab/stats');
                    const data = await response.json();
                    
                    if (data.success) {
                        const stats = data.stats;
                        statsInfo.innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            系统状态: 题目库包含 <strong>${stats.total_images}</strong> 张图片，
                            索引维度 <strong>${stats.feature_dimension}</strong>，
                            索引状态: ${stats.index_exists ? '<span class="text-success">已建立</span>' : '<span class="text-warning">未建立</span>'}
                        `;
                    } else {
                        statsInfo.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i> 
                            <span class="text-warning">${data.message}</span>
                        `;
                    }
                } catch (error) {
                    console.error('Stats error:', error);
                    statsInfo.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        <span class="text-danger">无法加载系统信息</span>
                    `;
                }
            }
            
            // 显示提示信息
            function showAlert(message, type) {
                // 创建alert元素
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // 插入到页面顶部
                const container = document.querySelector('.cab-container');
                container.insertBefore(alertDiv, container.firstChild);
                
                // 5秒后自动消失
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>